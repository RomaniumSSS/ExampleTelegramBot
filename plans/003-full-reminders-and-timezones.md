# План: Напоминания и Поддержка Часовых Поясов

## Цель (Objective)
Реализовать систему ежедневных уведомлений для трекинга состояния ("вайба"), которые приходят пользователю в удобное для него время, учитывая его локальный часовой пояс.

## Реализованный функционал

### Часть 1: Базовая система напоминаний
1.  **База данных**:
    *   Модель `User` расширена полями:
        *   `reminders_enabled` (Вкл/Выкл напоминаний).
        *   `reminder_morning_time` (Время утреннего напоминания).
        *   `reminder_evening_time` (Время вечернего напоминания).
2.  **Планировщик (Scheduler)**:
    *   Использован `APScheduler`.
    *   Задача запускается каждую минуту и проверяет, кому нужно отправить уведомление.
3.  **Интерфейс**:
    *   Команда `/reminders` открывает меню настроек.
    *   Кнопки для включения/выключения и изменения времени.

### Часть 2: Поддержка часовых поясов
1.  **База данных**:
    *   Добавлено поле `timezone` в модель `User` (по умолчанию "UTC").
2.  **Интерфейс**:
    *   Добавлена кнопка "Изменить часовой пояс".
    *   Поддержка ввода города (например, "Warsaw", "Moscow") или региона ("Europe/Warsaw").
    *   Валидация введенного часового пояса через библиотеку `pytz`.
3.  **Логика уведомлений**:
    *   Планировщик теперь работает не по серверному времени, а перебирает активных пользователей.
    *   Для каждого пользователя текущее время конвертируется в его локальное время.
    *   Если локальное время пользователя совпадает с установленным временем напоминания (с точностью до минуты), отправляется уведомление.
4.  **Логика статистики и графиков**:
    *   Отчеты `/stats` и графики `/moodchart` строятся с учетом локальных суток пользователя (начало дня в 00:00 по его времени), а не по UTC.

## Технические детали
*   **Библиотеки**: `aiogram`, `tortoise-orm`, `aerich` (миграции), `apscheduler`, `pytz` (таймзоны), `matplotlib` (графики).
*   **Миграции**: Созданы и применены две миграции:
    1.  `1_..._add_reminders.py` — добавление полей времени.
    2.  `2_..._add_timezone.py` — добавление поля timezone.

## Риски и их решение
*   **Производительность**: Перебор всех пользователей каждую минуту может быть медленным при большой базе (тысячи пользователей).
    *   *Решение (MVP)*: Для текущего масштаба это допустимо. В будущем можно оптимизировать, выбирая из БД только тех, у кого (ServerTime + Offset) ~= TargetTime, или хранить timestamp следующего уведомления.
*   **Ошибки ввода**: Пользователь может ввести несуществующий город.
    *   *Решение*: Реализован умный поиск по базе таймзон `pytz` и поддержка популярных алиасов.

## Статус
✅ Все пункты плана выполнены и протестированы.

